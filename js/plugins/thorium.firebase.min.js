/*!
 * Google Firebase functions for Thorium Mobile projects
 * Version 4.0 April, 2024
 * framework7 v8.x (https://framework7.io)
 * Google firebase (https://firebase.google.com)
 * framework7: MIT Licensed
 * Copyright 2018-2024 Thorium builder.
*/
if(firebase){var firebaseApp=firebase.initializeApp(firebaseConfig);firebaseApp?(thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Firebase initialized"),firebase.auth().useDeviceLanguage()):(thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Unable to initialize Firebase App"),app.dialog.alert("Unable to initialize Firebase App "))}else thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Unable to initialize Firebase"),app.dialog.alert("Unable to initialize Firebase ");var firebasePlugin={name:"Thorium Builder Firebase Plugin",bundleid:"com.thoriumbuilder.firebase",version:"4.0",initialized:!1,ls:null,rsp:null,rs:null,ps:null,avatarChanged:!1,token:"",firestoredb:firebase.firestore(),translatescreen:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Translate Firebase Dialogs");var e=getLangResources().tr;$("*[data-translate]:not(input):not(textarea)").each((function(a){var i=e[$(a).attr("data-translate")];i&&(a.innerText=i)})),$("input[data-translate]").each((function(a){var i=e[$(a).attr("data-translate")];i&&(a.placeholder=i)}))},getTranslatedString:e=>getLangResources().tr[e]||null,showLoginScreen:function(e){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Loading Login Popup"),firebasePlugin.ls=app.loginScreen.create({el:".login-screen"}),firebasePlugin.ls.open(!0),app.emit("onShowLoginScreen",e)},showRegisterScreen:function(e){e&&e.preventDefault(),thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Loading Register Popup"),firebasePlugin.rs=app.popup.create({el:".register-screen",swipeToClose:!0}),firebasePlugin.rs.open(!0),app.emit("onShowRegisterScreen",e)},showResetPwScreen:function(e){e&&e.preventDefault(),thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Loading Reset Password Popup"),firebasePlugin.rsp=app.popup.create({el:".resetpassword-screen",swipeToClose:!0}),$(".firebase_resetpw_email").val($(".firebase_email").val()),firebasePlugin.rsp.open(!0),app.emit("onShowResetPwScreen",e)},updateUserExt:function(e){var a=firebase.auth().currentUser;if(a){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Updating user Information"),1==kShowPreloader&&app.preloader.show();var i=a.uid;if(1==firebasePlugin.avatarChanged){var r=$("#firebase_profile_avatar_input").data("data-blob"),t=$("#firebase_profile_avatar_input").data("data-file").name;r.name=t;var o=(t=t.replace("C:\\fakepath\\","")).substr(t.lastIndexOf(".")+1),n=firebase.storage().ref().child(firebaseStoragePath+"/"),s=app.utils.id("-xxxx-xxxx");t=i+s+"."+o;n.child(t).put(r).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)})).then((function(e){e.task.on("state_changed",(function(e){var a=e.bytesTransferred/e.totalBytes*100;document.getElementById("firebase-upload-progress").value=a}),(function(e){app.preloader.hide(),app.dialog.alert(e.message)}),(function(){n.child(t).getDownloadURL().then((function(e){$(".firebase_avatar").attr("src",e),a.updateProfile({photoURL:e}).then((function(e){firebasePlugin.setUserShadow(a)})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))})).catch((function(e){app.preloader.hide(),app.dialog.alert("Error while uploading image: "+e.message)}))})).catch((function(e){app.preloader.hide(),app.dialog.alert("Error while uploading image: "+e.message)})),e.task.snapshot.ref.getDownloadURL().then((function(e){$(".firebase_avatar").attr("src",e),a.updateProfile({photoURL:e}).then((function(e){firebasePlugin.setUserShadow(a)})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))}))}))}}var l=$("#firebase_profile_displayname").val();a.updateProfile({displayName:l}).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)})).then((function(e){firebasePlugin.setUserShadow(a),setTimeout((function(){app.preloader.hide(),firebasePlugin.ps.close()}),1e3)}))},setUserShadow:function(e){if(e){var a=firebasePlugin.firestoredb;if(a){var i=a.collection("thorium.users").doc(e.uid);i.get().then((function(a){if(a.exists){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase]  Update user Shadow Information");var r=e.pa||"";i.update({displayName:e.displayName,emailVerified:e.emailVerified,language:r,creationTime:e.metadata.creationTime,lastSignInTime:e.metadata.lastSignInTime,photoURL:e.photoURL,email:e.email,anonymous:e.isAnonymous}).catch((function(e){var a="[com.thoriumbuilder.firebase] Firebase Plugin: Error writing User document: "+e.message;thoriumapi.logEvent(2,a),app.dialog.alert(a)}))}else{thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Plugin: Create user Shadow Information");r=e.pa||"";i.set({displayName:e.displayName,emailVerified:e.emailVerified,language:r,creationTime:e.metadata.creationTime,lastSignInTime:e.metadata.lastSignInTime,photoURL:e.photoURL,email:e.email,anonymous:e.isAnonymous}).catch((function(e){var a="[com.thoriumbuilder.firebase] Error writing User document: "+e.message;thoriumapi.logEvent(2,a),app.dialog.alert(a)}))}})).catch((function(e){var a="[com.thoriumbuilder.firebase] Error getting User document: "+e.message;thoriumapi.logEvent(2,a),app.dialog.alert(a)}))}}},resizeImage:function(e,a){return thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Resizing Image"),new Promise((function(i,r){var t="x",o=new FileReader;o.onloadend=function(){var n=new Image;n.src=o.result,n.onload=function(){var r=n.width,o=n.height;r>o?r>a&&(o*=a/r,r=a):o>a&&(r*=a/o,o=a);var s=document.createElement("canvas");s.width=r,s.height=o,s.getContext("2d").drawImage(this,0,0,r,o);var l=e.type||"image/jpg";t=s.toDataURL(l),i(t)},n.onerror=function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Image Resize Error "+e),r("Image Resize Error "+e)}},o.readAsDataURL(e)}))},firebase_handleProfileImage:function(e){firebasePlugin.resizeImage(e,256).then((function(a){var i=thoriumCorePlugin.dataURItoBlob(a);i.name=a.name;var r=new FileReader;r.onload=function(a){var r=a.target.result;$(".firebase_profile_avatar").attr("src",r),$("#firebase_profile_avatar_input").data("data-file",e),$("#firebase_profile_avatar_input").data("data-blob",i),firebasePlugin.avatarChanged=!0},r.readAsDataURL(e)}))},resetPasswordExt:function(e){e.preventDefault(),thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Opening Reset Password Dialog");const a=firebasePlugin.getTranslatedString("resetpassword")||"Reset Password";app.dialog.confirm(a+"?",(function(){var e=$(".firebase_resetpw_email").val();e.length>0&&(1==kShowPreloader&&app.preloader.show(),firebase.auth().sendPasswordResetEmail(e).then((function(){app.preloader.hide(),$(".firebase_email").val(e);const a=firebasePlugin.getTranslatedString("emailsent")||"an email has been sent to your address";app.dialog.alert(a),firebasePlugin.rsp.close()})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Reset Password Error: "+e.message),app.dialog.alert(e.message)})))}))},logoutExt:function(e){app.preloader.show(),firebase.auth().signOut().then((function(){app.preloader.hide(),thoriumapi.reloadHomePage(),firebasePlugin.initialize(),app.emit("onAuthSignOut",e),thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Logout Command Sent")})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Logout Error: "+e.message),app.dialog.alert(e.message)}))},signInExt:function(e){e.preventDefault(),1==kShowPreloader&&app.preloader.show();var a=$(".firebase_email").val(),i=$(".firebase_password").val();firebase.auth().signInWithEmailAndPassword(a,i).then((function(e){app.preloader.hide(),firebasePlugin.ls&&firebasePlugin.ls.close()})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] SignIn Error: "+e.message),app.dialog.alert(e.message)}))},createUserExt:function(e){if(e){e.user.uid;var a=$("#firebase_register_displayname").val();$("#firebase_register_displayname").val();e.user&&(e.user.updateProfile({displayName:a,photoURL:"img/defaultavatar.png"}).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] Update Error: "+e.message),app.dialog.alert(e.message)})),firebasePlugin.setUserShadow(e.user),app.preloader.hide(),$("#firebase_email").val($("#firebase_register_email").val()),$("#firebase_password").val($("#firebase_register_password").val()),firebasePlugin.rs.close(),firebasePlugin.ls&&firebasePlugin.ls.close(),$(".firebase_avatar").attr("alt",a),$(".firebase_avatar").attr("title",a),thoriumapi.showNotification("Welcome "+a))}},registerExt:function(e){e.preventDefault(),1==kShowPreloader&&app.preloader.show();var a=$("#firebase_register_email").val(),i=$("#firebase_register_password").val();if(i!=$("#firebase_register_password_verification").val()){app.preloader.hide();const e=firebasePlugin.getTranslatedString("pwmatch")||"Password does not match";return app.dialog.alert(e),thoriumapi.logEvent(1,"[com.thoriumbuilder.firebase] Password does not match"),void $("#firebase_register_password_verification").focus()}if(i.length<6){app.preloader.hide();const e=firebasePlugin.getTranslatedString("pwlength")||"Password must contain at least 6 characters";return app.dialog.alert(e),thoriumapi.logEvent(1,"[com.thoriumbuilder.firebase] Password Too Short"),void $("#firebase_register_password").focus()}1==kShowPreloader&&app.preloader.show();var r=firebase.auth().currentUser;if(r&&1==r.isAnonymous){var t=firebase.auth.EmailAuthProvider.credential(a,i);firebase.auth().currentUser.linkWithCredential(t).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] linkWithCredential Error: "+e.message),app.dialog.alert(e.message)})).then((function(e){app.preloader.hide(),firebasePlugin.createUserExt(e)}))}else firebase.auth().createUserWithEmailAndPassword(a,i).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] createUserWithEmailAndPassword Error: "+e.message),app.dialog.alert(e.message)})).then((function(e){app.preloader.hide(),firebasePlugin.createUserExt(e)}))},resetRepeaters:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] no user connected, reset all Repeaters"),$(".virtual-list").each((function(e){thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Reset Repeater with ID: ["+e.id+"]"),e.setAttribute("data-loaded","false");var a=$("#"+e.id),i=app.virtualList.get(a);i&&i.deleteAllItems()}))},handleStateChangedExt:function(e){if(app.preloader.hide(),e){if(e.uid==firebasePlugin.token)return;if(firebasePlugin.token=e.uid,1==e.isAnonymous&&0==firebaseAnonymous)return firebasePlugin.logoutExt(),void $(".apploader").hide();thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Authentification State Changed - User Connected with UID:["+e.uid+"]");e.displayName,e.email,e.emailVerified,e.photoURL,e.isAnonymous,e.uid,e.providerData;if($(".firebase-user-logout").show(),$("#firebase_login").hide(),$(".firebase_email").val(e.email),$(".firebase_displayname").text(e.displayName),1==e.isAnonymous)$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt","anonymous"),$(".firebase_avatar").attr("title","anonymous"),thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Anonymous User Signed In with UID:["+e.uid+"]");else{var a=e.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",a),$(".firebase_avatar").attr("alt",e.displayName),$(".firebase_avatar").attr("title",e.displayName),firebasePlugin.setUserShadow(e)}$("#view-main").show(),$(".apploader").hide(),firebasePlugin.ls&&firebasePlugin.ls.close()}else{if("none"==firebasePlugin.token)return void $(".apploader").hide();thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] Firebase User Signed Out"),$("#auth_name").text(""),$("#auth_img").attr("src",""),$(".firebase-user-logout").hide(),$("#firebase_login").show(),$(".firebase_email").val(""),$(".firebase_displayname").text(""),$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt",""),$(".firebase_avatar").attr("title",""),firebasePlugin.resetRepeaters(),0==firebaseAnonymous?(firebasePlugin.token="none",firebasePlugin.showLoginScreen(),setTimeout((function(){$(".apploader").hide()}),500)):firebase.auth().signInAnonymously().catch((function(e){firebasePlugin.token="none",thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] signInAnonymously Error: "+e.message),firebasePlugin.showLoginScreen(),setTimeout((function(){$(".apploader").hide()}),500)})).then((function(e){var a=e.user;a?(firebasePlugin.token=a.uid,thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] signInAnonymously success with uid: "+a.uid),setTimeout((function(){$(".apploader").hide()}),500)):(firebasePlugin.token="none",thoriumapi.logEvent(2,"[com.thoriumbuilder.firebase] signInAnonymously Error: "+a.uid))}))}},onFirebaseAvatarChange:function(e){e.preventDefault();var a=e.target.files[0];firebasePlugin.firebase_handleProfileImage(a)},showEditProfilePageExt:function(e){e&&e.preventDefault(),firebasePlugin.ps=app.popup.create({el:".profile-screen",swipeToClose:!1}),$(".firebase_resetpw_email").val($(".firebase_email").val());var a=firebase.auth().currentUser;if(a){firebasePlugin.ps.open(!0),$(".firebase_profile_displayname").val(a.displayName),$(".firebase_profile_email").val(a.email);var i=a.photoURL||"img/defaultavatar.png";$(".firebase_profile_avatar").attr("src",i),$(".firebase-displayname").text(a.displayName)}},facebookLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumapi.isLocal()){var a="[com.thoriumbuilder.firebase] Facebook Authentification not allowed with file: protocol";return app.dialog.alert(a),void thoriumapi.logEvent(1,a)}var i=new firebase.auth.FacebookAuthProvider;i.addScope("user_birthday"),firebase.auth().signInWithPopup(i).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},googleLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumapi.isLocal()){var a="[com.thoriumbuilder.firebase] Google Authentification not allowed with file: protocol";return app.dialog.alert(a),void thoriumapi.logEvent(1,a)}var i=new firebase.auth.GoogleAuthProvider;i.addScope("profile"),i.addScope("email"),firebase.auth().signInWithPopup(i).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},twitterLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumapi.isLocal()){var a="[com.thoriumbuilder.firebase] Twitter Authentification not allowed with file: protocol";return app.dialog.alert(a),void thoriumapi.logEvent(1,a)}var i=new firebase.auth.TwitterAuthProvider;firebase.auth().signInWithPopup(i).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},setUserAvatar:function(e){var a=firebase.auth().currentUser;if(null!=a){var i=a.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",i),$(".firebase_avatar").attr("alt",a.displayName),$(".firebase_avatar").attr("title",a.displayName)}},initialize:function(){$(".apploader").show(),firebasePlugin.translatescreen(),$(".login-screen-title").text(app.name),setTimeout((function(){$(".apploader").hide()}),2e3)},handleAvatarPopup:function(e,a){e.preventDefault();var i=firebase.auth().currentUser;if(i&&1!=i.isAnonymous){const i=e.target.getAttribute("data-page");if(i){var r=e.target.getAttribute("data-label");$("#firebasecustomprofile").attr("href","/"+i+"/"),$("#firebasecustomprofile").text(r),$("#firebasecustomprofile").show()}else $("#firebasecustomprofile").hide();app.popover.open(".firebase-popover",a,!0)}else{1==(firebaseAllowRegister||!1)&&firebasePlugin.showLoginScreen()}}};$("html").on("drop",(function(e){e.preventDefault()})),$("html").on("dragover",(function(e){e.preventDefault()})),$(document).on("dragenter",".firebase_profile_avatar",(function(e){e.preventDefault(),$(this).css("opacity","0.5"),e.stopPropagation()})),$(document).on("dragleave",".firebase_profile_avatar",(function(e){e.preventDefault(),$(this).css("opacity","1"),e.stopPropagation()})),$(document).on("drop",".firebase_profile_avatar",(function(e){e.preventDefault();var a=e.dataTransfer.files[0];$(this).css("opacity","1"),firebasePlugin.firebase_handleProfileImage(a),e.stopPropagation()})),$(document).on("click",".firebase_profile_avatar",(function(e){(e.preventDefault,1==thoriumapi.isLocal()&&(app.device.ios||app.device.android))&&app.tooltip.create({targetEl:$(this),text:"Drop your file here"}).show();$(".firebase_profile_avatar_input").trigger("click")})),$(document).on("change",".firebase_profile_avatar_input",(function(e){firebasePlugin.onFirebaseAvatarChange(e)})),$(document).on("submit",".firebase-signin-form",(function(e){firebasePlugin.signInExt(e)})),$(document).on("click",".firebase_register",(function(e){firebasePlugin.showRegisterScreen(e)})),$(document).on("click",".firebase_resetpasswword",(function(e){firebasePlugin.showResetPwScreen(e)})),$(document).on("click",".firebase_editprofile",(function(e){firebasePlugin.showEditProfilePageExt(e)})),$(document).on("click",".firebase-user-logout",(function(e){e.preventDefault();const a=firebasePlugin.getTranslatedString("logout")||"Logout";app.dialog.confirm(a+"?",(function(){firebasePlugin.logoutExt()}))})),$(document).on("click",".firebase_fb_login",(function(e){firebasePlugin.facebookLoginExt(e)})),$(document).on("click",".firebase_google_login",(function(e){firebasePlugin.googleLoginExt(e)})),$(document).on("click",".firebase_twitter_login",(function(e){firebasePlugin.twitterLoginExt(e)})),$(document).on("click",".firebase_avatar",(function(e){firebasePlugin.handleAvatarPopup(e,$(this))})),$(document).on("click",".resetpassword-submit",(function(e){e.preventDefault,1==document.getElementById("firebase-resetpw-form").checkValidity()&&firebasePlugin.resetPasswordExt(e)})),$(document).on("click",".submit_firebase-profile",(function(e){e.preventDefault,firebasePlugin.updateUserExt(e)})),$(document).on("click",".submit_firebase-register",(function(e){e.preventDefault,firebasePlugin.registerExt(e)})),$(document).on("input",".firebase_profile_displayname",(function(e){$(".firebase-displayname").text($(".firebase_profile_displayname").val())})),window.onerror=function(e,a,i){return thoriumapi.logEvent(2,"[com.thoriumbuilder.core] An error occured: "+e+"url="+a+" line"+i),!1},$(document).on("page:init",(function(e){firebasePlugin.setUserAvatar(e)})),firebase.auth().onAuthStateChanged((function(e){var a;app.emit("onAuthStateChanged",e),a=e?(e.isAnonymous=!0)?"Anonymous":e.displayName:"no session",thoriumapi.logEvent(0,"[com.thoriumbuilder.firebase] onAuthStateChanged ["+a+"]"),firebasePlugin.handleStateChangedExt(e),"undefined"!=typeof googleMapPlugin&&googleMapPlugin.initializePlugin(),"undefined"!=typeof firestorePlugin&&e&&($(".firebase-single-form").each((function(e){firestorePlugin.singleRecordFormInit(e)})),1==e.isAnonymous&&0==firebaseAnonymous?thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Current User is Anonymous"):(firestorePlugin.firebase_initFirebaseVirtualLists(!0),firestorePlugin.firebase_initFirebaseDisplayers(!0),"undefined"!=typeof openStreetMapPlugin&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] openStreetMapPlugin detected, initializing Maps"),setTimeout((function(){openStreetMapPlugin.reloadAllMaps()}),100))))}));