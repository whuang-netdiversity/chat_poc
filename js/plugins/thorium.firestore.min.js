/*!
 * Google Firebase Cloud Firestore functions for Thorium Mobile projects
 * Version 4.0 April, 2024
 * framework7 v8.x (https://framework7.io)
 * Google firebase (https://firebase.google.com)
 * framework7: MIT Licensed
 * Copyright 2018-2024 Thorium builder.
*/
var firestoredb=firebase.firestore(),firestorePlugin={name:"Thorium Builder Firestore Plugin",bundleid:"com.thoriumbuilder.firestore",version:"4.0",shoppingCartPopup:null,currentItem:{},convertFormData:function(e,t,i,r){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] converting Form data");var a=e.classList.contains("shadow-text");if("checkbox"==e.type)"true"===i||!0===i||"1"===i||"on"===i?(r[t]="on",e.setAttribute("checked","checked")):(r[t]="off",e.removeAttribute("checked"));else if("select-one"==e.type||"select"==e.tagName.toLowerCase){$("#"+e.id).attr("data-value",i);var o=$("#"+e.id).closest(".smart-select");if(o&&o.length>0){var l=app.smartSelect.get(o);l&&l.setValue(i)}else{$("#"+e.id).val(i),0==$("#"+e.id).html().trim().length&&$("#"+e.id).html('<option value="'+i+'">'+i+"</option>")}r[t]=i}else if("image"==e.type)$("#"+e.id+"-fileinput-filename").css("visibility","hidden"),i&&i.length>0&&($("#"+e.id).css("background-image","url("+i+")"),$("#"+e.id+"-fileinput-filename span").text(i),$("#"+e.id+"-remove").show());else if("range"==e.type){r[t]=i;var n=app.range.get(e.parentElement);n?n.setValue(i):(n=app.range.create(e.parentElement)).setValue(i)}else if(1==a){r[t]=i;var u=e.id.replaceAll("-shadow",""),d=app.textEditor.get("#"+u);d&&d.setValue(i)}else if("text"==e.type)e.value=i;else if("textarea"==e.type)e.value=i;else if("radio"==e.type)for(var s=e.closest("ul"),p=e.getAttribute("name"),c=s.querySelectorAll("input[name='"+p+"']"),f=0;f<c.length;f++){const e=c[f];e.value==i?e.setAttribute("checked","checked"):e.removeAttribute("checked")}else if("file"==e.type){var m=e.getAttribute("data-fileinput-ref"),g=$("#"+m);if(g&&g.length>0){$("#"+m+"-fileinput-filename span");$("#"+m+"-fileinput-filename").show(),$("#"+m+"-fileinput-filename").css("visibility","visible"),$("#"+m+"-fileinput-filename span").text(i),$("#"+m+"-fileinput-filename i").show(),$("#"+m+"-fileinput-link").show(),$("#"+m+"-fileinput-link span").html('<a class="external" target="_blank" rel="noopener" data-rel="external" target="_blank" href="'+i+'">See attached file</a>'),i.length>0?$("#"+m+"-remove").show():$("#"+m+"-fileinput-filename").css("visibility","hidden")}r[t]=i}else r[t]=i,e.value=i;return r},formBeforeSubmitFunction:function(e){const t=e.getAttribute("data-form-beforesubmit");if(t){const a=window[t];var i=[e];if("function"==typeof a){a.apply(this,i);thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Function ["+t+"] Called for Form with id ["+e.id+"]")}else{var r='[com.thoriumbuilder.core] An error occured "'+t+'" is not an existing function';thoriumapi.logEvent(2,r)}}},updateFormData:function(e,t){e.preventDefault;var i=e.target;if(0!=app.input.validateInputs(i)){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Sending Form data to Cloud Firestore"),1==kShowPreloader&&app.preloader.show(),firestorePlugin.formBeforeSubmitFunction(i),app.emit("onFirestoreBeforeUpdate",e);var r=e.target.getAttribute("data-firebase-collection");if(!r||0==r.length||"null"==r)return app.preloader.hide(),void app.dialog.alert("Firebase Collection not defined");var a=e.target.getAttribute("data-form-message")||null,o=e.target.getAttribute("data-form-postprocess")||0,l=e.target.getAttribute("data-uid")||null;if(!l){app.preloader.hide();var n="[com.thoriumbuilder.firestore] Record ID not set";return thoriumapi.logEvent(1,n),void app.dialog.alert(n)}var u=firebase.auth().currentUser,d=firestoredb.collection(r).doc(l);if(!d){n="[com.thoriumbuilder.firestore] Record not found";return thoriumapi.logEvent(1,n),void app.dialog.alert(n)}for(var s={},p={},c=e.target,f=0;f<c.length;f++){const t="_alias",i=["name"+t,"id"+t,"description"+t,"this"+t,"title"+t,"submit"+t];var m=c[f].name;!0===i.includes(m)&&(m=m.replaceAll(t,""));c[f].type;if("radio"==c[f].type)!0===c[f].checked&&(s[m]=c[f].value);else if("checkbox"==c[f].type)1==c[f].checked?s[m]=!0:s[m]=!1;else if("submit"==c[f].type);else if("file"==c[f].type){var g=c[f].id,h=$("#"+g).data("data-blob"),b=$("#"+g).data("data-filename"),v=$("#"+g)[0].name.replace("-fileinput","");if(!v)return app.preloader.hide(),err="Invalid File Reference",app.emit("onFirestoreBeforeUpdateError",e.target,err),void app.dialog.alert("Error writing document: "+err);if(h)thoriumCorePlugin.uploadFile(h,b,r,l,v,d);else{var A=$("#"+g)[0].id;if(A){A=A.replace("-fileinput","");var y=document.getElementById(A);y&&"true"==y.getAttribute("data-clear")&&(p[v]="")}}}else s[m]=c[f].value;m&&null!=s[m]&&(p[m]=s[m])}var E=null;u&&(E=u.uid);var F=Date.now();p.modifiedby=E,p.modifieddate=F,d.update(p).then((function(){for(var t=document.querySelectorAll(".firebase-form"),i=0;i<t.length;i++){if((u=t[i]).getAttribute("data-collection")==r&&u.getAttribute("data-firebase-uid")==l){var n=u.getAttribute("data-parent-key")||null;firestorePlugin.firebase_initFirebaseDisplayer(u,r,l,n,1,null)}}if((t=document.querySelectorAll(".firebase-virtual-list-content[data-collection='"+r+"']"))&&t.length>0)for(i=0;i<t.length;i++){var u=t[i],d=app.virtualList.get(u);if(d&&d.items)for(var s=0;s<d.items.length;s++){var c=d.items[s];if(c.uid==l){for(const[e,t]of Object.entries(p))c[e]=t;d.replaceItem(s,c),d.update();break}}}app.preloader.hide(),app.emit("onFirestoreUpdateSuccess",e.target,p),a&&thoriumapi.showNotification(a),"true"==(e.target.getAttribute("data-reset-form")||"false")&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Form Reset"),e.target.reset(),$("#"+e.target.id+" .text-editor").each((function(e){var t=app.textEditor.get("#"+e.id);t&&t.setValue("")}))),0==o?thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Form Sent"):1==o?(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Going Back to Previous Page"),thoriumapi.backToPreviousPage()):2==o&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Reloading Home Page"),thoriumapi.reloadHomePage());var f=e.target.getAttribute("data-return-function")||null;if(f){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Form with id ["+e.target.id+"] : Calling JS function ["+f+"]");var m=window[f],g=[e.target,p];if("function"==typeof m){var h=m.apply(this,g);app.preloader.hide(),app.emit("userFormSuccess",h),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] JS function ["+f+"] called successfully when submitting Form with id ["+e.target.id+"]")}else{app.preloader.hide();var b='An error occured "'+f+'" is not an existing function';thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] JS function ["+f+"] called with Error: ["+b+"] when submitting Form with id ["+e.target.id+"]"),thoriumapi.showAlert(b),app.emit("userFormError",b||null)}}})).catch((function(e){app.preloader.hide();var t="[com.thoriumbuilder.firestore] Error Updating document: "+e.message;thoriumapi.logEvent(2,t),app.dialog.alert(t)}))}else thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Missing Mandatory fields for Form with id ["+i.id+"]")},insertDocument:function(e,t){var i=e.target;if(0!=app.input.validateInputs(i)){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Inserting Document"),app.emit("onFirestoreBeforeInsert",t),firestorePlugin.formBeforeSubmitFunction(i),1==kShowPreloader&&app.preloader.show();var r=t.attr("data-firebase-collection");if(!r)return app.preloader.hide(),void app.dialog.alert("Firebase Collection not defined");for(var a=t.attr("data-form-message")||null,o=t.attr("data-form-postprocess")||0,l=0;l<i.length;l++){i[l].name;var n=i[l].getAttribute("data-mandatory")||"false";if("file"==i[l].type&&n&&"true"==n)if(!$("#"+i[l].id).data("data-blob"))return app.preloader.hide(),void app.dialog.alert("You must select a file")}var u={},d={},s=firebase.auth().currentUser,p=null,c=null;s&&(p=s.uid,c=s.displayName);var f=Date.now();d.createdby=p,d.createddate=f,d.createdbyname=c;var m=e.target.getAttribute("data-parent-key")||null;m&&"null"!=m&&(d.parentuid=m);for(l=0;l<i.length;l++){const e="_alias",t=["name"+e,"id"+e,"description"+e,"this"+e,"title"+e,"submit"+e];var g=i[l].name;!0===t.includes(g)&&(g=g.replaceAll(e,"")),"radio"==i[l].type?!0===i[l].checked&&(u[g]=i[l].value):"checkbox"==i[l].type?u[g]=i[l].checked:"submit"==i[l].type||"file"==i[l].type||(u[g]=i[l].value),g&&null!=u[g]&&(d[g]=u[g])}thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Inserting Record in Collection "+r);firestoredb.collection(r).add(d).catch((function(e){app.preloader.hide(),app.emit("onFirestoreInsertError",t,e),thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] Error writing document: "+e.message),app.dialog.alert("Error writing document: "+e.message)})).then((function(t){for(var l=0;l<i.length;l++)if("file"==i[l].type){var n=i[l].id,u=$("#"+n).data("data-blob"),s=$("#"+n).data("data-filename"),p=$("#"+n)[0].name.replace("-fileinput","");if(!p)return app.preloader.hide(),err="Invalid File Reference",thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] Error writing document, Invalid File Reference"),app.emit("onFirestoreBeforeUpdateError",i,err),void app.dialog.alert("Error writing document: "+err);u&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Upload Blob to collection "+r),thoriumCorePlugin.uploadFile(u,s,r,t.id,p,t))}thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] document added to collection "+r),setTimeout((function(){firestorePlugin.reloadVlAfterInsert(r),app.preloader.hide(),"true"==(e.target.getAttribute("data-reset-form")||"false")&&(e.target.reset(),$("#"+e.target.id+" .text-editor").each((function(e){var t=app.textEditor.get("#"+e.id);t&&t.setValue("")})),$(".firebase_document_preview").css("background-image",""),$(".input-filename span").html(""),$(".firebase_fileupload-rotate").hide(),$(".firebase_fileupload-remove").hide(),$(".input-filename i").hide()),a&&thoriumapi.showNotification(a),1==o?thoriumapi.backToPreviousPage():2==o&&thoriumapi.reloadHomePage(),app.emit("onFirestoreInsertSuccess",i,t);var l=e.target.getAttribute("data-return-function")||null;if(l){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Form with id ["+e.target.id+"] : Calling JS function ["+l+"]");var n=window[l],u=[e.target,d];if("function"==typeof n){var s=n.apply(this,u);app.preloader.hide(),app.emit("userFormSuccess",s),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] JS function ["+l+"] called successfully when submitting Form with id ["+e.target.id+"]")}else{app.preloader.hide();var p='An error occured "'+l+'" is not an existing function';thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] JS function ["+l+"] called with Error: ["+p+"] when submitting Form with id ["+e.target.id+"]"),thoriumapi.showAlert(p),app.emit("userFormError",p||null)}}}),1e3)}))}else thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Missing Mandatory fields for Form with id ["+i.id+"]")},singleRecordFormInit:function(e){if("true"!=e.getAttribute("data-loaded")){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Initialize Single Record Form with ID ["+e.id+"]");var t=e.getAttribute("data-firebase-collection");if(!t||"null"==t||0==t.length)return $(e).hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] Collection not set for Single Record Form with ID ["+e.id+"]"),void app.dialog.alert("Firebase Collection not set!");var i=firebase.auth().currentUser;if(!i||1==i.isAnonymous)return $(e).hide(),app.preloader.hide(),void thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] User not Connected, unable to Initialize Single Record Form with ID ["+e.id+"]");var r={};e.setAttribute("data-uid",i.uid);var a=firestoredb.collection(t).doc(i.uid);return firestoredb.runTransaction((function(o){return o.get(a).then((function(a){if(a.exists){var o=a.data();if(o)for(var[l,n]of Object.entries(o)){var u=e.querySelector('*[name="'+l+'"]');u&&(r=firestorePlugin.convertFormData(u,l,n,r))}}else firestoredb.collection(t).doc(i.uid).set(r)}))})).then((function(){$(e).show(),e.setAttribute("data-loaded",!0),app.emit("onFirestoreAfterFillEditForm",e,r),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore]  Single Record Form with ID ["+e.id+"] initialized successfully")})).catch((function(t){e.setAttribute("data-loaded",!1),app.preloader.hide(),app.emit("onFirestoreSingleRecordFormInitError",e,t);var i="[com.thoriumbuilder.firestore] Error on Single Record Form Initialization"+t.message;thoriumapi.logEvent(2,i),app.dialog.alert(i)}))}},firestoreRenderCollectionFromData:function(e,t,i){if(e.innerHTML=$("#"+e.id+"-template")[0].outerHTML,0==t.length&&(e.innerHTML=e.innerHTML+thoriumCorePlugin.emtyResultTemplate,app.preloader.hide()),t.length>0){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Rendering Collection ["+t.length+" rows]"),$("#"+e.id).data("items",t);var r=0;for(var a in t){var o=t[a],l=i,n='id="'+e.id+'-template-row"';for(var u in l=l.replace(n,'id="'+e.id+"-template-row-"+r+'"'),o){var d=o[u];null==d&&(d="&nbsp;"),l=(l=l.replaceAll("{{"+u+"}}",d)).replaceAll("{"+u+"}",d)}if(l=l.replaceAll("templaterow",""),e.innerHTML=e.innerHTML+l,(r+=1)>=199)break}e.setAttribute("data-loaded",!0),e.setAttribute("data-count",t.length),app.preloader.hide()}},firestoreGetRepeaterData:function(e,t){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Get Repeater data");var i=e.id;t&&t.length>0&&e.setAttribute("data-parent-key",t),t=e.getAttribute("data-parent-key"),e.setAttribute("data-loaded",!0),1==kShowPreloader&&app.preloader.show();var r,a=i+"-template",o=document.getElementById(a);if(0==(r=o?o.innerHTML:$("#"+i).data("template")).length)return thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] Unable to get Template for Repeater with ID ["+i+"]"),void app.preloader.hide();$("#"+i).data("template",r);var l=[];const n=e.getAttribute("data-filter-field"),u=e.getAttribute("data-filter-operator"),d=e.getAttribute("data-filter-value"),s=e.getAttribute("data-filter-field2"),p=e.getAttribute("data-filter-operator2"),c=e.getAttribute("data-filter-value2"),f=(e.getAttribute("data-template"),e.getAttribute("data-limit")||null),m=e.getAttribute("data-order-field")||null,g="true"==e.getAttribute("data-user-data")||!1,h="true"==e.getAttribute("data-collection-mode")||!1;var b=e.getAttribute("data-collection")||null;if(!b)return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),"Collection not Defined"),void app.dialog.alert("Error getting documents, Collection not Defined");var v=firestoredb.collection(b);if(t)try{v=v.where("parentuid","==",t)}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(thoriumapi.txtToUrl(e.message))}if(n){var A="";if(A="false"!=d&&("true"==d||d),"{useruid}"==d&&(A=firebase.auth().currentUser.uid),d.indexOf("{")>=0&&d.indexOf("}")>=0){const e=d.replace("{","").replace("}","");if(e&&e.length>0){var y="";try{y=window[e]}catch(t){app.preloader.hide();var E="[com.thoriumbuilder.firestore] Unable to find variable "+e+"] "+t;return void app.dialog.alert(E)}if(!y){app.preloader.hide();E="[com.thoriumbuilder.firestore] variable ["+e+"] is undefined";return void app.dialog.alert(E)}A=y}}try{v=v.where(n,u,A)}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(e.message)}}if(s){if(A="false"!=c&&("true"==c||c),"{useruid}"==c&&(A=firebase.auth().currentUser.uid),c.indexOf("{")>=0&&c.indexOf("}")>=0){const e=c.replace("{","").replace("}","");if(e&&e.length>0){y="";try{y=window[e]}catch(t){app.preloader.hide();E="[com.thoriumbuilder.firestore] Unable to find variable "+e+"] "+t;return void app.dialog.alert(E)}if(!y){app.preloader.hide();E="[com.thoriumbuilder.firestore] variable ["+e+"] is undefined";return void app.dialog.alert(E)}A=y}}try{v=v.where(s,p,A)}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(e.message)}}if(1==g){var F=firebase.auth().currentUser;try{v=v.where("createdby","==",F.uid)}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(e.message)}}if(f&&f>0)try{v=v.limit(parseInt(f))}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(e.message)}if(m){var w=e.getAttribute("data-order-way")||"asc";try{v=v.orderBy(m,w)}catch(e){return app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e.message),void app.dialog.alert(e.message)}}v.get().then((function(t){var i=0;t.forEach((function(e){var t={};for(var r in t=e.data())if(null==t[r]&&(t[r]="&nbsp;"),"thorium_count_likes"==r){var a=t[r];1==a?t[r]="1 like":a>1&&(t[r]=a+" likes")}t.dataindex=i,t.uid=e.id,t.thorium_comments_count&&0!=t.thorium_comments_count.length||(t.thorium_comments_count=""),t.thorium_count_likes&&0!=t.thorium_count_likes.length||(t.thorium_count_likes=""),l.push(t),i+=1})),1==h?firestorePlugin.firestoreRenderCollectionFromData(e,l,r):thoriumCorePlugin.virtuallist.renderVirtualListFromData(e,l,r),app.emit("firebaseVirtualListLoadSuccess",e,l.length,l)})).catch((function(e){app.preloader.hide(),app.emit("firebaseVirtualListLoadError",$(this),e),app.dialog.alert(thoriumapi.txtToUrl(e.message))}))},firebase_initFirebaseVirtualLists:function(e,t){if(e=e||!1,t=t||null,firebase.auth().currentUser){e=e||!1;for(var i=document.querySelectorAll(".firebase-virtual-list-content"),r=0;r<i.length;r++){var a=i[r];"true"==(a.getAttribute("data-loaded")||"false")&&1!=e||firestorePlugin.firestoreGetRepeaterData(a,t)}}},firebase_initFirebaseDisplayer:function(e,t,i,r,a,o){a=a||0,r=r||null,o=o||null;var l=[],n=firebase.auth().currentUser;if((!n||1==n.isAnonymous)&&2==a)return thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] User not Connected, unable to Initialize Displayer with ID ["+e.id+"]"),void(e.style.display="none");thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Initialize Displayer with id ["+e.id+"]");var u,d=e.closest(".page-content");if(d&&app.preloader.showIn(d),0!=a){if(1==a)thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Displayer ["+e.id+"] Initialization Mode : Load from UID ["+i+"]) "),u=firestoredb.collection(t).doc(i);else if(2==a)thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Displayer ["+e.id+"] Initialization Mode : Load User Record for user with uid ["+n.uid+"]) "),u=firestoredb.collection(t).doc(n.uid);else if(3==a){thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Displayer ["+e.id+"] Initialization Mode : Load User Owner Record from Firebase Collection ["+t+"] UID ["+i+"]) ");var s=o.createdby;u=firestoredb.collection("thorium.users").doc(s)}else if(4==a)if(o){if(o.parentuid){var p=o.parentuid;thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Displayer ["+e.id+"] Initialization Mode : Load Parent Record from Firebase Collection ["+t+"] UID ["+p+"]) "),u=firestoredb.collection(t).doc(p)}}else thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] No Record Found for Displayer ["+e.id+"]");return thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Call Firebase Transaction for  Displayer with id ["+e.id+"]"),firestoredb.runTransaction((function(i){return i.get(u).then((function(i){if(i.exists){var r=i.data();for(var[a,o]of Object.entries(r))l[a]=o;firestorePlugin.fillDisplayerFromData(e,l,null,null,t),e.style.display="block"}else thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] No Record Found for Displayer ["+e.id+"]"),d&&app.preloader.hideIn(d),e.style.display="none"}))})).then((function(){d&&app.preloader.hideIn(d),e.setAttribute("data-loaded",!0),app.emit("onFirestoreAfterFillEditForm",e,l),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore]  Single Record Form with ID ["+e.id+"] initialized successfully")})).catch((function(t){e.setAttribute("data-loaded",!1),d&&app.preloader.hideIn(d),e.style.display="none",app.emit("onFirestoreSingleRecordFormInitError",e,t);var i="[com.thoriumbuilder.firestore] Error on Single Record Form with ID ["+e.id+"] Initialization"+t.message;thoriumapi.logEvent(2,i),app.dialog.alert(i)}))}},firebase_initFirebaseDisplayers:function(e,t){e=e||!1,t=t||null;var i=firebase.auth().currentUser;thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Initializing all Firebase Displayers"),i&&(e=e||!1,$(".firebase-form[data-loading-mode]").each((function(i){var r=i.getAttribute("data-loading-mode")||0,a=i.getAttribute("data-loaded")||!1;if(r>0&&0==a||r>0&&1==e){var o=i.getAttribute("data-firebase-collection"),l=i.getAttribute("data-firebase-uid");r=i.getAttribute("data-loading-mode")||0;firestorePlugin.firebase_initFirebaseDisplayer(i,o,l,t,r)}})))},filterButtonclick:function(e){app.emit("firebaseFilterBtnClick",e);var t=e.target.getAttribute("data-filter-virtuallist"),i=app.virtualList.get("#"+t);i&&app.virtualList.destroy(i);var r=document.getElementById(t);if(r){const t=e.target.getAttribute("data-filter-field")||"",i=e.target.getAttribute("data-filter-operator")||"==",a=e.target.getAttribute("data-filter-value")||"",o=e.target.getAttribute("data-filter-field2")||"",l=e.target.getAttribute("data-filter-operator2")||"==",n=e.target.getAttribute("data-filter-value2")||"",u=e.target.getAttribute("data-limit")||"",d=e.target.getAttribute("data-order-field")||"",s=e.target.getAttribute("data-order-way")||"asc",p=e.target.getAttribute("data-user-data")||!1;r.setAttribute("data-filter-field",t),r.setAttribute("data-filter-operator",i),r.setAttribute("data-filter-value",a),r.setAttribute("data-filter-field2",o),r.setAttribute("data-filter-operator2",l),r.setAttribute("data-filter-value2",n),r.setAttribute("data-limit",u),r.setAttribute("data-order-field",d),r.setAttribute("data-order-way",s),r.setAttribute("data-user-data",p),firestorePlugin.firestoreGetRepeaterData(r)}},fillFormFromData:function(e,t,i,r,a){if(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Loading Data for Form with ID: ["+e.id+"]"),1!=("true"==e.getAttribute("data-loaded")||!1)){if(!t)return app.preloader.hide(),$("#"+e.id).hide(),void app.dialog.alert("Record not found!");if(app.emit("onFirestoreBeforeFillEditForm",e),$("#"+e.id).attr("data-uid",t.uid),!a){app.preloader.hide();var o="[com.thoriumbuilder.firestore] Missing Firebase Collection Name: ["+e.id+"]";return thoriumapi.logEvent(2,o),void app.dialog.alert(o)}e.setAttribute("data-firebase-collection",a);var l=firestoredb.collection(a).doc(t.uid);if(!l)return app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] No Record found for Form with ID: ["+e.id+"]"),void app.dialog.alert("Record not found!");var n={};l.get().then((function(t){if(t.exists){var a=t.data();for(var[o,l]of Object.entries(a)){var u=e.querySelector('*[name="'+o+'"]');u&&firestorePlugin.convertFormData(u,o,l,n)}e.setAttribute("data-loaded",!0),e.setAttribute("data-row-index",i),e.setAttribute("data-virtuallist-id",r),app.emit("onFirestoreAfterFillEditForm",e,Object.entries(a)),setTimeout((function(){app.preloader.hide()}),1e3)}else app.preloader.hide(),app.dialog.alert("No such document!")})).catch((function(t){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Error while loading data for Form with ID: ["+e.id+"] :"+t),app.emit("onFirestoreBeforeFillEditFormError",e,t),app.dialog.alert("Error getting document: "+t)}))}else app.preloader.hide()},setDisplayerMap:function(e,t,i,r){if(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Set Displayer Map Content"),t||i||r){var a=e.getAttribute("data-engine")||"",o={latitude:0,longitude:0,target:""};if(i.length>0&&r.length>0)o.latitude=i,o.longitude=r;else if(t){var l=t.split(",");2==l.length&&(o.latitude=l[0],o.longitude=l[1])}o.name=o.latitude+"-"+o.longitude;var n=document.getElementById(e.id),u=n.getAttribute("data-zoom")||5;if(n.setAttribute("data-zoom",u),n.setAttribute("data-lat",o.latitude),n.setAttribute("data-lng",o.longitude),"googlemap"==a&&"undefined"!=typeof googleMapPlugin){var d=Base64.encode('[{"name":  "'+o.name.escapeSpecialChars()+'","lat":  '+o.latitude+',"lng":  '+o.longitude+"}]");n.setAttribute("data-markers",d),googleMapPlugin.initializeMap(e.id)}else if("osm"==a&&"undefined"!=typeof openStreetMapPlugin){var s=openStreetMapPlugin.initMap(e.id);openStreetMapPlugin.addMarkerAt(s,o.latitude,o.longitude,o)}}else thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] invalid coordinates ")},fillDisplayerFromData:function(e,t,i,r,a){$("#"+e.id+" [data-firebase-field]").each((function(e){var i=e.tagName.toLowerCase(),r=e.className.toLowerCase(),a=e.getAttribute("data-firebase-field");if(["embed-responsive-item"].indexOf(r)>-1&&"audio"!=i&&"video"!=i){var o=e.closest(".firebase-img");a in t&&t[a]?(e.style.backgroundImage="url('"+t[a]+"')",e.style.display="block",o&&(o.style.display="block")):(e.style.display="none",o&&(o.style.display="none"))}else if(["embed-responsive-item"].indexOf(r)>-1&&"video"==i)a in t&&t[a]?e.setAttribute("src",t[a]):$("#"+e.id).parent().hide();else if("audio"==i)a in t&&t[a]?e.setAttribute("src",t[a]):e.style.display="none";else if(1==r.includes("db-map")){var l=e.getAttribute("data-firebase-field-lat")||"",n=e.getAttribute("data-firebase-field-lng")||"",u=null,d=null;l in t&&l in t&&(u=t[l],d=t[n]),u&&d&&firestorePlugin.setDisplayerMap(e,null,u,d)}else if(a in t){var s=e.getAttribute("data-firebase-field")||null,p="";s&&""==e.innerHTML&&(p="{{"+s+"}}"),e.innerHTML!="{{"+s+"}}"&&(p=e.innerHTML),p=(p=p.replaceAll("{{"+a+"}}",t[a])).replaceAll("{"+a+"}",t[a]),e.innerHTML=p,"a"==i&&(e.setAttribute("href",t[a]),(p=e.getAttribute("href"))&&(p=(p=p.replaceAll("{{"+a+"}}",t[a])).replaceAll("{"+a+"}",t[a]),e.setAttribute("href",p)))}else e.style.display="none"})),$("#"+e.id+" .firebase-action-button").each((function(e){e.setAttribute("data-key",i),e.setAttribute("data-index",r),e.setAttribute("data-collection",a),$("#"+e.id).data("record",t),e.setAttribute("data-from-displayer",!0);var o=t.thorium_comments_count||"";$(e).children(".tb-comments-link").attr("data-count",o)})),$("#"+e.id+" .firebase-like").each((function(e){var i=t.thorium_count_likes||"";$(e).children("span").html(i)})),e.setAttribute("data-collection",a),e.setAttribute("data-loaded",!0),t&&t.uid&&e.setAttribute("data-firebase-uid",t.uid),$("#"+e.id).data("record",t),app.preloader.hide()},deleteElementFromVirtualists:function(e,t){for(var i=document.querySelectorAll(".firebase-virtual-list-content"),r=0;r<i.length;r++){var a=i[r];if(a.getAttribute("data-collection")==e){var o=app.virtualList.get(a);if(o){for(var l=0;l<o.items.length;l++){if((d=o.items[l]).uid==t){var n=l,u=o.items[n];if(firestoredb.collection(e).doc(t)&&u){o.deleteItem(n);break}}}for(l=0;l<o.items.length;l++){var d;(d=o.items[l]).dataindex=l,o.replaceItem(l,d)}o.update()}}}},deleteDocument:function(e){var t=e.getAttribute("data-collection")||null,i=e.getAttribute("data-key")||null,r=e.getAttribute("data-from-displayer")||null;if(t&&i){var a=firestoredb.collection(t).doc(i);if(!a){app.preloader.hide();var o="Record not found";return app.emit("onFirestoreDeleteError",vl,o),void app.dialog.alert(o)}a.delete().then((function(){firestorePlugin.deleteElementFromVirtualists(t,i),"true"==r&&thoriumapi.backToPreviousPage(),app.preloader.hide(),app.emit("onFirestoreDeleteSuccess",t,i)})).catch((function(e){app.preloader.hide(),app.emit("onFirestoreDeleteError",t,i,e),app.dialog.alert("Delete Error "+e.message)}))}},initFormSelectWithCollection:function(e,t,i){if(!firebase.auth().currentUser)return app.preloader.hide(),void thoriumapi.logEvent(1,"[com.thoriumbuilder.firestore] User not Connected, unable to Initialize Select Input Form with ID ["+e.id+"]");thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Loading Data from Collection ["+t+"]");var r=firestoredb.collection(t);(r=r.orderBy(i)).get().then((function(r){var a=0,o='<option value="" disabled>...</option>';r.forEach((function(e){var t;t=e.data(),o=o+'<option value="'+t[i]+'">'+t[i]+"</option>",a+=1})),thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Loading Collection Data from ["+t+"] ["+a+" records]"),app.emit("dataloadSuccess",e),e.innerHTML=o;var l=e.getAttribute("data-value")||"";if(l.length>0){var n=$(e).closest(".smart-select");if(n&&n.length>0){var u=app.smartSelect.get(n);u&&u.setValue(l)}else e.value=l}$("#"+e.id).removeClass("disabled"),e.setAttribute("data-loaded","true"),app.preloader.hide()})).catch((function(t){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] Loading Data from Collection Error ["+t.message+"]"),app.emit("firebaseLoadError",e,t),app.dialog.alert(thoriumapi.txtToUrl(t.message))}))},initialize:function(){},InitPage:function(e){var t,i,r,a,o,l,n,u=e.detail;if("smart-select-page"!=u.name&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.firestore] Initializing Page"),u===page?n=app.root:(n=u.$el,t=u.route),n&&t)){if(t.query.data){var d=JSON.parse(t.query.data);firestorePlugin.currentItem=d}i=firestorePlugin.currentItem,r=t.query.rowindex||null,a=t.query.parentvlid||null,o=t.query.key||null,l=t.query.collection||null;var s=i;firebase.auth().currentUser&&(firestorePlugin.firebase_initFirebaseVirtualLists(!1,o),$(".firebase-form").each((function(e){if("true"!=e.getAttribute("data-loaded")){var t=e.getAttribute("data-loading-mode")||0;if(e.setAttribute("data-parent-key",o),t>0){var i=e.getAttribute("data-firebase-collection"),a=e.getAttribute("data-firebase-uid");firestorePlugin.firebase_initFirebaseDisplayer(e,i,a,o,t,s)}else firestorePlugin.fillDisplayerFromData(e,s,o,r,l),e.style.display="block"}})),$(".firebase-edit-form").each((function(e){e.setAttribute("data-parent-key",o),firestorePlugin.fillFormFromData(e,s,r,a,l)})),$(".firebase-single-form").each((function(e){firestorePlugin.singleRecordFormInit(e)})),$(".firebase-display-form").each((function(e){e.setAttribute("data-parent-key",o),firestorePlugin.fillFormFromData(e,s,r,a,l)})),$(".firebase-insert-form").each((function(e){e.setAttribute("data-parent-key",o)}))),app.preloader.hide()}},reloadVlAfterInsert:function(e){if(firebase.auth().currentUser){var t=document.querySelectorAll(".firebase-virtual-list-content");if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r.getAttribute("data-collection")==e)if(app.virtualList.get(r)){var a=r.getAttribute("data-parent-key");firestorePlugin.firestoreGetRepeaterData(r,a)}}}},loadLineItem:function(e,t){var i=t.attr("data-index")||null,r=t.attr("data-key")||null;if(i){var a=t.parents(".firebase-virtual-list-content");if(a){var o=app.virtualList.get("#"+a[0].id),l=a.attr("data-detail")||null,n=a.attr("data-collection")||null,u=o.items[i];firestorePlugin.currentItem=u;var d=app.view,s=t.closest(".virtual-list")||null,p=null;s&&(p=s[0].id);var c=s.attr("data-transition"),f=null;c&&(f={transition:c}),d&&d.length>0&&l&&(app.emit("firebaseVirtualListLineClick",t,i,u,l),d[0].router.navigate("/"+l+"/?rowindex="+i+"&key="+r+"&parentvlid="+p+"&collection="+n,f))}}}};$(document).on("click",".btn-firebase-filter",(function(e){e.preventDefault,firestorePlugin.filterButtonclick(e)})),$(document).on("submit",".firebase-single-form",(function(e){firestorePlugin.updateFormData(e,!1)})),$(document).on("submit",".firebase-edit-form",(function(e){firestorePlugin.updateFormData(e,!0)})),$(document).on("submit",".firebase-insert-form",(function(e){e.preventDefault,firestorePlugin.insertDocument(e,$(this))})),$(document).on("click",".item-firebase",(function(e){e.preventDefault();var t=$(".ptr-content");t&&1==t.hasClass("ptr-transitioning")||(e.target.classList.contains("firebase-action-button")?e.stopPropagation():firestorePlugin.loadLineItem(e,$(this)))})),$(document).on("click","a.btn-firebase-page",(function(e){e.preventDefault();var t=this.getAttribute("data-index")||null,i=this.getAttribute("data-key")||null,r=this.getAttribute("data-target")||null,a=this.getAttribute("data-transition")||null;if(1==("true"==this.getAttribute("data-from-displayer")||!1)){var o=this.getAttribute("data-key")||null,l=app.view,n=$(this).data("record")||null;firestorePlugin.currentItem=n;var u=this.getAttribute("data-collection")||null;app.emit("firebaseVirtualListLineClick",this,t,n,r),l[0].router.navigate("/"+r+"/?rowindex="+t+"&key="+i+"&collection="+u,{animate:!0,transition:a,reloadAll:!1})}else if(t){var d=$(this).parents(".firebase-virtual-list-content");if(d){n=app.virtualList.get("#"+d[0].id).items[t];firestorePlugin.currentItem=n;l=app.view;var s=$(this).closest(".virtual-list")||null;o=null;s&&s.length>0&&(o=s[0].id,u=s[0].getAttribute("data-collection")),l&&l.length>0&&(app.emit("firebaseVirtualListLineClick",$(this),t,n,r),l[0].router.navigate("/"+r+"/?rowindex="+t+"&key="+i+"&parentvlid="+o+"&collection="+u,{animate:!0,transition:a,reloadAll:!1}))}}})),$(document).on("click","a.btn-firebase-delete",(function(e){e.preventDefault();var t=this,i=this.getAttribute("data-confirm-message")||"Delete?",r=t.getAttribute("data-collection")||null;if(!r){var a=t.closest(".virtual-list");if(a&&(r=a.getAttribute("data-collection")||null),!r){var o=t.closest(".firebase-form");if(o&&(r=o.getAttribute("data-collection")||null),!r){app.preloader.hide();var l="Unable to get Collection for this action";thoriumapi.logEvent(2,"[com.thoriumbuilder.firestore] "+l),app.dialog.alert(l)}}}t.setAttribute("data-collection",r),app.dialog.confirm(i,(function(){setTimeout((function(){firestorePlugin.deleteDocument(t)}),100)}))})),$(document).on("click",".collection-item-firebase",(function(e){e.preventDefault();var t=$(this).attr("data-index")||null,i=$(this).attr("data-key")||null;if(t){var r=$(this).parents(".firebase-virtual-list-content");if(r){var a=r.data("items"),o=r.attr("data-detail")||null,l=r.attr("data-collection")||null,n=a[t];firestorePlugin.currentItem=n;var u=app.view,d=r.attr("data-transition"),s=null;d&&(s={transition:d}),u&&u.length>0&&u[0].router.navigate("/"+o+"/?rowindex="+n.rowindex+"&key="+i+"&collection="+l,s)}}})),$(document).on("page:mounted",(function(e,t){e.preventDefault,firestorePlugin.InitPage(e)}));